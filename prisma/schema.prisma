generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId       String   @unique
  userPassword String
  createdAt    DateTime @default(now())
  role         Role     @default(STUDENT)
  memberId     Int      @id @default(autoincrement())
  updatedAt    DateTime @default(now()) @updatedAt
  admin        Admin?   @relation("UserToAdmin")
  student      Student? @relation("UserToStudent")
}

model Admin {
  adminName              String
  adminPhone             String                  @unique
  memberId               Int                     @id
  adminMemo              String?
  adminPosition          String                  @default("조교")
  user                   User                    @relation("UserToAdmin", fields: [memberId], references: [memberId], onDelete: Cascade, onUpdate: NoAction)
  announcements          Announcement[]          @relation("AdminToAnnouncements")
  counselingReservations CounselingReservation[] @relation("AdminToCounselingReservation")
  counselingSchedules    CounselingSchedule[]    @relation("AdminToCounselingSchedule")
  qnaComments            QnABoardComment[]       @relation("AdminToQnAComment")
  academies              Academy[]               @relation("AdminToAcademy")
}

model Student {
  academyId              Int
  studentName            String
  studentPhone           String                  @unique
  studentHighschool      String?
  studentBirthYear       Int
  studentMemo            String?
  memberId               Int                     @id
  isActive               Boolean                 @default(true)
  counselingReservations CounselingReservation[] @relation("StudentToCounselingReservation")
  qnas                   QnABoard[]              @relation("StudentToQnA")
  qnaComments            QnABoardComment[]       @relation("StudentToQnAComment")
  academy                Academy                 @relation("AcademyToStudents", fields: [academyId], references: [academyId])
  user                   User                    @relation("UserToStudent", fields: [memberId], references: [memberId], onDelete: Cascade, onUpdate: NoAction)
  examResults            ExamResult[]            @relation("StudentToExamResult")

  @@index([academyId])
}

model Academy {
  academyId            Int            @id @default(autoincrement())
  academyName          String         @unique
  academyPhone         String         @unique
  academyAddress       String
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @default(now()) @updatedAt
  isActive             Boolean        @default(true)
  files                AcademyFile[]
  academyStudents      Student[]      @relation("AcademyToStudents")
  academyAdmins        Admin[]        @relation("AdminToAcademy")
  academyAnnouncements Announcement[] @relation("AnnouncementToAcademy")
}

model AcademyFile {
  academyId    Int
  fileId       Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  fileName     String
  fileSize     Int?
  fileType     String
  fileUrl      String
  originalName String
  academy      Academy  @relation(fields: [academyId], references: [academyId], onDelete: Cascade)

  @@index([academyId])
}

model Announcement {
  announcementId            Int                @id @default(autoincrement())
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  authorId                  Int?
  isItAssetAnnouncement     Boolean            @default(false)
  isItImportantAnnouncement Boolean            @default(false)
  announcementContent       String             @default("")
  announcementTitle         String             @default("")
  author                    Admin?             @relation("AdminToAnnouncements", fields: [authorId], references: [memberId])
  files                     AnnouncementFile[]
  academies                 Academy[]          @relation("AnnouncementToAcademy")

  @@index([authorId])
}

model AnnouncementFile {
  announcementId Int
  fileId         Int          @id @default(autoincrement())
  createdAt      DateTime     @default(now())
  fileName       String
  fileSize       Int?
  fileType       String
  fileUrl        String
  originalName   String
  announcement   Announcement @relation(fields: [announcementId], references: [announcementId], onDelete: Cascade)

  @@index([announcementId])
}

model QnABoard {
  qnaId        Int               @id @default(autoincrement())
  qnaTitle     String
  qnaContent   String
  qnaUserId    Int
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  isItAnswered Boolean           @default(false)
  student      Student           @relation("StudentToQnA", fields: [qnaUserId], references: [memberId], onDelete: Cascade, onUpdate: NoAction)
  comments     QnABoardComment[] @relation("QnAWithComments")
  files        QnAFile[]

  @@index([qnaUserId])
}

model QnAFile {
  fileId       Int      @id @default(autoincrement())
  qnaId        Int
  fileName     String
  originalName String
  fileUrl      String
  fileType     String
  fileSize     Int?
  createdAt    DateTime @default(now())
  qna          QnABoard @relation(fields: [qnaId], references: [qnaId], onDelete: Cascade)

  @@index([qnaId])
}

model QnABoardComment {
  commentId      Int      @id @default(autoincrement())
  commentContent String
  qnaId          Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  adminId        Int?
  studentId      Int?
  admin          Admin?   @relation("AdminToQnAComment", fields: [adminId], references: [memberId], onDelete: Cascade, onUpdate: NoAction)
  qna            QnABoard @relation("QnAWithComments", fields: [qnaId], references: [qnaId], onDelete: Cascade)
  student        Student? @relation("StudentToQnAComment", fields: [studentId], references: [memberId], onDelete: Cascade, onUpdate: NoAction)

  @@index([studentId])
  @@index([adminId])
  @@index([qnaId])
}

model CounselingSchedule {
  scheduleId   Int                    @id @default(autoincrement())
  adminId      Int
  date         DateTime
  timeSlotId   Int
  isAvailable  Boolean                @default(true)
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  reservations CounselingReservation?
  admin        Admin                  @relation("AdminToCounselingSchedule", fields: [adminId], references: [memberId], onDelete: Cascade)

  @@unique([adminId, date, timeSlotId])
  @@index([adminId])
  @@index([date])
}

model CounselingReservation {
  reservationId       Int                @id @default(autoincrement())
  studentId           Int
  adminId             Int
  scheduleId          Int                @unique
  consultationContent String
  status              ReservationStatus  @default(CONFIRMED)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  admin               Admin              @relation("AdminToCounselingReservation", fields: [adminId], references: [memberId], onDelete: Cascade)
  schedule            CounselingSchedule @relation(fields: [scheduleId], references: [scheduleId], onDelete: Cascade)
  student             Student            @relation("StudentToCounselingReservation", fields: [studentId], references: [memberId], onDelete: Cascade)

  @@index([studentId])
  @@index([adminId])
  @@index([scheduleId])
}

model Exam {
  examId         Int             @id @default(autoincrement())
  examName       String
  totalQuestions Int
  correctAnswers Json
  questionScores Json
  questionTypes  Json
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  examCategory   ExamCategory    @default(PASS_FAIL)
  passScore      Int?
  aiAnalysis     ExamAIAnalysis? @relation("ExamToAIAnalysis")
  results        ExamResult[]    @relation("ExamToExamResult")

  @@index([examCategory])
  @@map("exam")
}

model ExamResult {
  examResultId    Int                  @id @default(autoincrement())
  examId          Int
  studentId       Int
  totalScore      Int
  grade           Int
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  questionResults ExamQuestionResult[]
  exam            Exam                 @relation("ExamToExamResult", fields: [examId], references: [examId], onDelete: Cascade)
  student         Student              @relation("StudentToExamResult", fields: [studentId], references: [memberId], onDelete: Cascade)
  aiFeedback      StudentAIFeedback?   @relation("ExamResultToAIFeedback")

  @@index([examId])
  @@index([studentId])
  @@map("exam_results")
}

model ExamQuestionResult {
  id             Int        @id @default(autoincrement())
  examResultId   Int
  questionNumber Int
  selectedChoice String?
  isCorrect      Boolean
  score          Int
  examResult     ExamResult @relation(fields: [examResultId], references: [examResultId], onDelete: Cascade)

  @@unique([examResultId, questionNumber])
  @@index([examResultId])
  @@index([questionNumber])
  @@index([isCorrect])
  @@index([selectedChoice])
}

model Review {
  id            Int      @id @default(autoincrement())
  reviewerName  String
  reviewContent String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  reviewTitle   String   @default("")
}

model Toggle {
  id              Int      @id @default(1)
  isReviewPopupOn Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Textbook {
  textbookId   Int              @id @default(autoincrement())
  textbookName String
  isImportant  Boolean          @default(false)
  category     TextbookCategory
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  fileName     String
  fileSize     Int?
  fileType     String           @default("application/pdf")
}

model ExamAIAnalysis {
  id          Int       @id @default(autoincrement())
  examId      Int       @unique
  content     String
  isEdited    Boolean   @default(false)
  generatedAt DateTime  @default(now())
  editedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  exam        Exam      @relation("ExamToAIAnalysis", fields: [examId], references: [examId], onDelete: Cascade)

  @@map("exam_ai_analysis")
}

model StudentAIFeedback {
  id           Int        @id @default(autoincrement())
  examResultId Int        @unique
  content      String
  isEdited     Boolean    @default(false)
  generatedAt  DateTime   @default(now())
  editedAt     DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  examResult   ExamResult @relation("ExamResultToAIFeedback", fields: [examResultId], references: [examResultId], onDelete: Cascade)

  @@map("student_ai_feedback")
}

enum Role {
  DEVELOPER
  ADMIN
  STUDENT
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum TextbookCategory {
  LISTENING
  MATERIAL
  WEEKLY_TEST
  PPT
  ETC
  ASSISTANT
}

enum ExamCategory {
  GRADED
  PASS_FAIL
}
